{% comment %} Product Recommendation Section - carousel of recommended products {% endcomment %}
{%- assign product_id = product.id -%}
<div id="product-recommendation-{{ section.id }}" class="container mx-auto px-4 py-8 max-w-7xl product-recommendation-section my-8">
  <product-recommendations data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product_id }}&limit={{ section.settings.product_count | default: 4 }}">
  {% if section.settings.title != blank %}
    <h4 class="text-xl font-semibold mb-4">{{ section.settings.title }}</h4>
  {% endif %}

  {% if product and product.recommendations and product.recommendations.size > 0 %}
    <div class="glide recommendation-glide" id="glide-{{ section.id }}">
      <div class="glide__track" data-glide-el="track">
        <ul class="glide__slides">
          {% for p in product.recommendations limit: section.settings.product_count %}
            <li class="glide__slide px-2 h-full">
              <div class="p-4 h-full">
                <article class="recommendation-card flex flex-col overflow-hidden transition-transform transform h-full">
                  <div class="card-media relative overflow-hidden bg-gray-50 h-48">
                    {% if p.featured_image %}
                      <img src="{{ p.featured_image | image_url: width: 400}}" alt="{{ p.featured_image.alt | escape }}" class="w-full h-full object-contain">
                    {% elsif p.images and p.images.size > 0 %}
                      <img src="{{ p.images[0] | image_url: width: 400}}" alt="{{ p.title | escape }}" class="w-full h-full object-contain">
                    {% else %}
                      <div class="h-48 flex items-center justify-center bg-gray-100">{{ 'product-1' | placeholder_svg_tag }}</div>
                    {% endif %}

                    <a href="{{ p.url }}" class="quick-view-icon absolute top-2 right-2 rounded-full p-2 shadow-sm text-gray-700 hover:bg-gray-50" aria-label="Quick view">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </a>
                  </div>

                  <div class="card-body flex flex-col gap-2 flex-grow p-4">
                    <a href="{{ p.url }}" class="font-semibold text-sm text-gray-900 hover:underline">{{ p.title }}</a>
                    {% assign display_price = nil %}
                    {% if p.price %}
                      {% assign display_price = p.price %}
                    {% elsif p.variants and p.variants.first.price %}
                      {% assign display_price = p.variants.first.price %}
                    {% endif %}
                    {% if display_price %}
                      <p class="text-sm text-gray-600 mt-1">
                        {{ display_price | money }}
                        {% if p.tags contains 'isgstexempt' %}
                          <span class="ml-2 text-sm">(GST Exempt)</span>
                        {% else %}
                          <span class="ml-2 text-sm">(inc GST)</span>
                        {% endif %}
                      </p>
                      {% if section.settings.show_ex_gst %}
                        {% assign ex_price = display_price | divided_by: 1.1 | round %}
                        <p class="text-sm text-gray-600">{{ ex_price | money }} (ex. GST)</p>
                      {% endif %}
                    {% endif %}
                  </div>

                  <div class="p-4 border-t border-gray-100 bg-white">
                    {% if p.available and p.variants and p.variants.size == 1 %}
                      <form method="post" action="/cart/add">
                        <input type="hidden" name="id" value="{{ p.variants.first.id }}">
                        <button type="submit" class="w-full inline-flex items-center justify-center px-3 py-2 primary-cart-button">Add to cart</button>
                      </form>
                    {% else %}
                      <a href="{{ p.url }}" class="w-full inline-flex items-center justify-center px-3 py-2 primary-cart-button">Select options</a>
                    {% endif %}
                  </div>
                </article>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

        <div class="flex items-center justify-between mt-4">
        <div class="glide__arrows" data-glide-el="controls">
          <button class="product-gallery-arrow product-gallery-arrow--left" data-glide-dir="<" aria-label="Previous">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="product-gallery-arrow product-gallery-arrow--right" data-glide-dir=">" aria-label="Next">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var glideEl = document.getElementById('glide-{{ section.id }}');
        if (!glideEl) return;
        function init(){
          try{
            if (typeof Glide === 'undefined'){
              var s = document.createElement('script');
                s.src = '{{ "glide.min.js" | asset_url }}';
                s.onload = function(){
                  try {
                    var g = new Glide(glideEl, { type: 'slider', perView: 4, gap: 16, autoplay: false, startAt: 0, focusAt: 0, peek: { before: 0, after: 0 }, bound: true }).mount();
                    function updateArrowsState(){
                      try{
                        var left = glideEl.querySelector('.product-gallery-arrow--left');
                        var right = glideEl.querySelector('.product-gallery-arrow--right');
                        if (!left || !right) return;
                        var total = glideEl.querySelectorAll('.glide__slide').length || 0;
                        var perView = (g && g.settings && g.settings.perView) ? g.settings.perView : 1;
                        var idx = (typeof g.index === 'number') ? g.index : 0;
                        if (idx <= 0){ left.disabled = true; left.setAttribute('aria-disabled','true'); left.classList.add('opacity-40','pointer-events-none'); } else { left.disabled = false; left.removeAttribute('aria-disabled'); left.classList.remove('opacity-40','pointer-events-none'); }
                        if (idx >= Math.max(0, total - perView)){ right.disabled = true; right.setAttribute('aria-disabled','true'); right.classList.add('opacity-40','pointer-events-none'); } else { right.disabled = false; right.removeAttribute('aria-disabled'); right.classList.remove('opacity-40','pointer-events-none'); }
                      }catch(e){/*ignore*/}
                    }
                    updateArrowsState();
                    if (g && typeof g.on === 'function'){ g.on('run', updateArrowsState); g.on('mount.after', updateArrowsState); }
                    equalizeRecommendationHeights(glideEl);
                    window.addEventListener('resize', function(){ setTimeout(function(){ equalizeRecommendationHeights(glideEl); updateArrowsState(); },120); });
                  } catch(e) { console.warn(e); }
                };
                document.head.appendChild(s);
            } else {
              try {
                var g = new Glide(glideEl, { type: 'slider', perView: 4, gap: 16, autoplay: false, startAt: 0, focusAt: 0, peek: { before: 0, after: 0 }, bound: true }).mount();
                function updateArrowsState(){
                  try{
                    var left = glideEl.querySelector('.product-gallery-arrow--left');
                    var right = glideEl.querySelector('.product-gallery-arrow--right');
                    if (!left || !right) return;
                    var total = glideEl.querySelectorAll('.glide__slide').length || 0;
                    var perView = (g && g.settings && g.settings.perView) ? g.settings.perView : 1;
                    var idx = (typeof g.index === 'number') ? g.index : 0;
                    if (idx <= 0){ left.disabled = true; left.setAttribute('aria-disabled','true'); left.classList.add('opacity-40','pointer-events-none'); } else { left.disabled = false; left.removeAttribute('aria-disabled'); left.classList.remove('opacity-40','pointer-events-none'); }
                    if (idx >= Math.max(0, total - perView)){ right.disabled = true; right.setAttribute('aria-disabled','true'); right.classList.add('opacity-40','pointer-events-none'); } else { right.disabled = false; right.removeAttribute('aria-disabled'); right.classList.remove('opacity-40','pointer-events-none'); }
                  }catch(e){/*ignore*/}
                }
                updateArrowsState();
                if (g && typeof g.on === 'function'){ g.on('run', updateArrowsState); g.on('mount.after', updateArrowsState); }
                function imagesLoaded(root, cb){ try{ var imgs = Array.prototype.slice.call(root.querySelectorAll('img')); if (!imgs || imgs.length===0) return cb(); var c=0,L=imgs.length; imgs.forEach(function(i){ if (i.complete){ c++; if (c===L) cb(); return; } i.addEventListener('load', function(){ c++; if (c===L) cb(); }); i.addEventListener('error', function(){ c++; if (c===L) cb(); }); }); }catch(e){ cb(); } }
                imagesLoaded(glideEl, function(){ try{ equalizeRecommendationHeights(glideEl); updateArrowsState(); }catch(e){} });
                window.addEventListener('resize', function(){ setTimeout(function(){ imagesLoaded(glideEl, function(){ equalizeRecommendationHeights(glideEl); updateArrowsState(); }); },120); });
              } catch(e){ console.warn(e); }
            }

            function equalizeRecommendationHeights(root){
              try{
                if (!root) return;
                var cards = root.querySelectorAll('.recommendation-card');
                if (!cards || cards.length===0) return;
                // reset
                cards.forEach(function(c){ c.style.minHeight = ''; });
                var maxH = 0;
                cards.forEach(function(c){ var h = c.offsetHeight; if (h > maxH) maxH = h; });
                if (maxH > 0) cards.forEach(function(c){ c.style.minHeight = maxH + 'px'; });
              }catch(e){ console.warn(e); }
            }
          }catch(e){ console.warn(e); }
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
      })();
    </script>

  {% else %}
    <div class="product-recommendation-fallback">
      <p class="text-sm text-gray-500">No recommendations available.</p>
    </div>

    <script>
      (function(){
        try {
          var host = document.querySelector('#product-recommendation-{{ section.id }} product-recommendations');
          if (!host) return;
          var url = host.getAttribute('data-url');
          if (!url) return;
          function insertJsonPath(u){
            var q = u.indexOf('?');
            if (q === -1) return u + '.json';
            return u.slice(0,q) + '.json' + u.slice(q);
          }

          function fetchJsonWithFallback(u){
            return fetch(u, { credentials: 'same-origin' }).then(function(res){
              if (!res.ok) throw res;
              var ct = (res.headers.get('content-type') || '');
              if (ct.indexOf('application/json') > -1) return res.json();
              return res.text().then(function(txt){ try { return JSON.parse(txt); } catch(e){ throw res; } });
            }).catch(function(){
              var alt = insertJsonPath(u);
              if (alt === u) alt = u + '.json';
              return fetch(alt, { credentials: 'same-origin' }).then(function(r2){ if (!r2.ok) throw new Error('no data'); return r2.json(); });
            });
          }

          fetchJsonWithFallback(url).then(function(json){
            // normalize image URLs to request a 200px width from Shopify CDN when possible
            function normalizeImageUrl(u){
              try{
                if (!u) return u;
                if (u.indexOf('//') === 0) u = 'https:' + u;
                if (u.indexOf('cdn.shopify.com') !== -1){
                  if (u.indexOf('width=') === -1){
                    u = u + (u.indexOf('?') === -1 ? '?' : '&') + 'width=200';
                  }
                }
              }catch(e){/*ignore*/}
              return u;
            }

            var items = [];
            // API may return an array or an object with products
            if (Array.isArray(json)) items = json;
            else if (json && Array.isArray(json.products)) items = json.products;
            if (!items || items.length === 0) return; // keep fallback

            // build glide html
            var glideHtml = '<div class="glide recommendation-glide" id="glide-{{ section.id }}">';
            glideHtml += '<div class="glide__track" data-glide-el="track"><ul class="glide__slides">';
            items.slice(0, {{ section.settings.product_count | default: 4 }}).forEach(function(p){
                var handle = '';
                if (p.handle) handle = p.handle;
                else if (p.url){
                  try{
                    var tmpH = document.createElement('a'); tmpH.href = p.url;
                    var parts = tmpH.pathname.split('/'); handle = parts.pop() || parts.pop() || '';
                  }catch(e){ handle = (p.url && p.url.split('/').pop()) || ''; }
                }
                var href = '#';
                if (p.url){
                  try{
                    var tmp = document.createElement('a'); tmp.href = p.url;
                    href = tmp.pathname + (tmp.hash || '');
                  }catch(e){ href = (p.url && p.url.split('?')[0]) || '#'; }
                } else if (handle){ href = '/products/' + handle; }
                // pick a usable image URL: featured_image (string or object), media[].src, or images[]
                var img = '';
                if (p.featured_image) {
                  if (typeof p.featured_image === 'string') img = p.featured_image.indexOf('//')===0 ? ('https:' + p.featured_image) : p.featured_image;
                  else if (p.featured_image.src) img = p.featured_image.src;
                  else if (p.featured_image.url) img = p.featured_image.url;
                }
                if (!img && p.media && p.media[0] && p.media[0].src) img = p.media[0].src;
                if (!img && p.images && p.images.length) { img = p.images[0]; if (img && img.indexOf('//')===0) img = 'https:' + img; }
                // ensure we request a 200px width image for client-rendered slides
                img = normalizeImageUrl(img);
              var title = p.title || '';
              var rawPrice = '';
              if (typeof p.price !== 'undefined' && p.price !== null) rawPrice = p.price;
              else if (p.variants && p.variants[0] && typeof p.variants[0].price !== 'undefined') rawPrice = p.variants[0].price;
              var price = '';
              if (rawPrice !== '' && (typeof rawPrice === 'number' || !isNaN(parseFloat(rawPrice)))){
                var num = (typeof rawPrice === 'number') ? rawPrice : parseFloat(rawPrice);
                if (num > 1000) { price = '$' + (num/100).toFixed(2); } else { price = '$' + (num).toFixed(2); }
              } else if (rawPrice) { price = String(rawPrice); }
              // GST detection from tags (tags may be string CSV or array)
              var isGstExempt = false;
              if (p.tags){ if (typeof p.tags === 'string'){ if (p.tags.indexOf('isgstexempt') !== -1) isGstExempt = true; } else if (Array.isArray(p.tags) && p.tags.indexOf('isgstexempt') !== -1) isGstExempt = true; }
              var showExGst = {{ section.settings.show_ex_gst | json }};
              glideHtml += '<li class="glide__slide px-2 h-full">';
              glideHtml += '<div class="p-4 h-full">';
              glideHtml += '<article class="recommendation-card flex flex-col overflow-hidden transition-transform transform h-full">';
              glideHtml += '<div class="card-media relative overflow-hidden h-48">';
              if (img) {
                glideHtml += '<img src="'+img+'" alt="'+(title.replace(/"/g,''))+'" class="w-full h-full object-contain">';
              } else {
                glideHtml += '<div class="h-48 flex items-center justify-center bg-gray-100"></div>';
              }
              glideHtml += '<a href="'+href+'" class="quick-view-icon absolute top-2 right-2 bg-white rounded-full p-2 shadow-sm text-gray-700 hover:bg-gray-50" aria-label="Quick view">';
              glideHtml += '<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>';
              glideHtml += '</a>';
              glideHtml += '</div>';
              glideHtml += '<div class="card-body flex flex-col gap-2 flex-grow p-4">';
              glideHtml += '<a href="'+href+'" class="font-semibold text-sm text-gray-900 hover:underline">'+title+'</a>';
              if (price){
                glideHtml += '<p class="text-sm text-gray-600 mt-1">'+price+'<span class="ml-2 text-sm">'+(isGstExempt? '(GST Exempt)' : '(inc GST)')+'</span></p>';
                if (showExGst){
                  // compute ex GST if numeric
                  var exPrice = '';
                  var raw = rawPrice;
                  if (raw !== '' && (typeof raw === 'number' || !isNaN(parseFloat(raw)))){
                    var n = (typeof raw === 'number') ? raw : parseFloat(raw);
                    var cents = n > 1000 ? n : Math.round(n*100); // normalize if not cents
                    var ex = Math.round(cents / 1.1);
                    exPrice = '$' + (ex/100).toFixed(2);
                  }
                  if (exPrice) glideHtml += '<p class="text-sm text-gray-600">'+exPrice+' (ex. GST)</p>';
                }
              }
              glideHtml += '</div>';
              glideHtml += '<div class="p-4 border-t border-gray-100 bg-white">';
              if (p.available && p.variants && p.variants.length == 1) {
                glideHtml += '<form method="post" action="/cart/add"><input type="hidden" name="id" value="'+(p.variants[0].id || '')+'"><button type="submit" class="w-full inline-flex items-center justify-center px-3 py-2 primary-cart-button">Add to cart</button></form>';
              } else {
                glideHtml += '<a href="'+href+'" class="w-full inline-flex items-center justify-center px-3 py-2 primary-cart-button">Select options</a>';
              }
              glideHtml += '</div>';
              glideHtml += '</article></div></li>';
            });
            glideHtml += '</ul></div>';
            glideHtml += '<div class="flex items-center justify-between mt-4">';
            glideHtml += '<div class="glide__arrows" data-glide-el="controls">';
            glideHtml += '<button class="product-gallery-arrow product-gallery-arrow--left" data-glide-dir="<" aria-label="Previous">';
            glideHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>';
            glideHtml += '<button class="product-gallery-arrow product-gallery-arrow--right" data-glide-dir=">" aria-label="Next">';
            glideHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>';
            glideHtml += '</div></div></div>';

            // preserve existing title (if present) so client injection doesn't remove it
            var existingTitle = host.querySelector('h4');
            var titleHtml = existingTitle ? existingTitle.outerHTML : '';
            host.innerHTML = titleHtml + glideHtml;

            var glideEl = host.querySelector('.glide') || host.querySelector('#glide-{{ section.id }}');
            if (!glideEl) return;
            function equalizeRecommendationHeights(root){
              try{
                if (!root) return;
                var cards = root.querySelectorAll('.recommendation-card');
                if (!cards || cards.length===0) return;
                cards.forEach(function(c){ c.style.minHeight = ''; });
                var maxH = 0;
                cards.forEach(function(c){ var h = c.offsetHeight; if (h > maxH) maxH = h; });
                if (maxH > 0) cards.forEach(function(c){ c.style.minHeight = maxH + 'px'; });
              }catch(e){ console.warn(e); }
            }

            function imagesLoaded(root, cb){
              try{
                var imgs = Array.prototype.slice.call(root.querySelectorAll('img'));
                if (!imgs || imgs.length === 0) return cb();
                var count = 0; var L = imgs.length;
                imgs.forEach(function(img){
                  if (img.complete){ count++; if (count===L) cb(); return; }
                  img.addEventListener('load', function(){ count++; if (count===L) cb(); });
                  img.addEventListener('error', function(){ count++; if (count===L) cb(); });
                });
              }catch(e){ cb(); }
            }

            function mountGlide(){ try { var g = new Glide(glideEl, { type: 'slider', perView: 4, gap: 16, autoplay: false, startAt: 0, focusAt: 0, peek: { before: 0, after: 0 }, bound: true }).mount();
              function updateArrowsState(){
                  try{
                    var left = glideEl.querySelector('.product-gallery-arrow--left');
                    var right = glideEl.querySelector('.product-gallery-arrow--right');
                    if (!left || !right) return;
                    var total = glideEl.querySelectorAll('.glide__slide').length || 0;
                    var perView = (g && g.settings && g.settings.perView) ? g.settings.perView : 1;
                    var idx = (typeof g.index === 'number') ? g.index : 0;
                    if (idx <= 0){ left.disabled = true; left.setAttribute('aria-disabled','true'); left.classList.add('opacity-40','pointer-events-none'); } else { left.disabled = false; left.removeAttribute('aria-disabled'); left.classList.remove('opacity-40','pointer-events-none'); }
                    if (idx >= Math.max(0, total - perView)){ right.disabled = true; right.setAttribute('aria-disabled','true'); right.classList.add('opacity-40','pointer-events-none'); } else { right.disabled = false; right.removeAttribute('aria-disabled'); right.classList.remove('opacity-40','pointer-events-none'); }
                  }catch(e){/*ignore*/}
                }
                // wait for images before equalizing heights and initial arrow state
                imagesLoaded(glideEl, function(){
                  try{ updateArrowsState(); equalizeRecommendationHeights(glideEl); }catch(e){}
                });
                if (g && typeof g.on === 'function'){ g.on('run', updateArrowsState); g.on('mount.after', updateArrowsState); }
                window.addEventListener('resize', function(){ setTimeout(function(){ imagesLoaded(glideEl, function(){ equalizeRecommendationHeights(glideEl); updateArrowsState(); }); },120); });
              } catch(e){ console.warn(e); } }
            if (typeof Glide === 'undefined'){
              var s = document.createElement('script'); s.src = '{{ "glide.min.js" | asset_url }}';
              s.onload = mountGlide; document.head.appendChild(s);
            } else { mountGlide(); }
          }).catch(function(err){ /* keep fallback message */ });
        } catch(e){ console.warn(e); }
      })();
    </script>
  {% endif %}
  </product-recommendations>
</div>

{% schema %}
{
  "name": "Product recommendation",
  "settings": [
    { "type": "text", "id": "title", "label": "Title", "default": "You may also like" },
    { "type": "range", "id": "product_count", "label": "Number of products to fetch", "default": 10, "min": 1, "max": 12, "step": 1 },
    { "type": "checkbox", "id": "show_ex_gst", "label": "Show ex. GST prices", "default": false }
  ],
  "blocks": [],
  "presets": [ { "name": "Product recommendation", "category": "Product" } ]
}
{% endschema %}
