{% comment %} Main cart section - simple server-rendered cart with update/remove forms {% endcomment %}
<section class="container mx-auto px-4 max-w-7xl">
  {%- capture page_title -%}
    {{ 'cart.general.title' | t }}
{%- endcapture -%}
  {% render 'page-title', title: page_title, show_breadcrumb: true %}

  {% if cart.item_count == 0 %}
    <div class="text-center py-12">
      <p class="text-gray-600 mb-4">Your cart is currently empty.</p>
      <a href="/" class="inline-block bg-black text-white px-4 py-2 rounded">Return to shop</a>
    </div>
  {% else %}
    {% render 'shipping-goals', cart:cart %}
    <a href="#" id="esafetyClearCart" class="text-sm underline mb-4 inline-block">Clear Cart</a>
    <div class="grid gap-6">
      <div>
        <form id="cart-update-form" action="{{ routes.cart_url }}" method="post">
          <div class="w-full">
            <!-- header -->
            <div class="hidden md:grid grid-cols-4 gap-4 text-left border-b border-grey py-2">
              <div class="font-medium text-base uppercase text-center">Product</div>
              <div class="font-medium text-base uppercase text-center">Price</div>
              <div class="font-medium text-base uppercase text-center">Quantity</div>
              <div class="font-medium text-base uppercase text-center">Total</div>
            </div>

            <div class="divide-y">
              {% comment %} Render parent items (non-addon) as rows using divs {% endcomment %}
              {% for item in cart.items %}
                {% unless item.properties.is_addon == 'true' %}
                  {% render 'cart-line-item', item: item, index: forloop.index %}
                {% endunless %}
              {% endfor %}
            </div>
          </div>

          <script>
            (function () {
              // Bind view-fixings buttons on the cart page. Scope lookups to the clicked row
              // and measure panel height robustly (handles images/loading).
              function bindFixingToggles() {
                document.querySelectorAll('.view-fixings-btn').forEach(function (btn) {
                  if (btn._fixingsBound) return;
                  btn._fixingsBound = true;
                  btn.addEventListener('click', function () {
                    var key = btn.getAttribute('data-parent-key');
                    var scope = btn.closest('[data-has-addons]') || btn.parentNode;
                    var panel = scope
                      ? scope.querySelector('.fixings-panel[data-parent-key="' + key + '"]')
                      : document.querySelector('.fixings-panel[data-parent-key="' + key + '"]');
                    var icon = btn.querySelector('.view-fixings-icon');
                    if (!panel) return;
                    var isOpen = panel.getAttribute('data-open') === 'true';
                    if (isOpen) {
                      // collapse smoothly
                      panel.style.maxHeight = panel.scrollHeight + 'px';
                      void panel.offsetHeight;
                      panel.style.maxHeight = '0';
                      panel.setAttribute('data-open', 'false');
                      if (icon) icon.style.transform = '';
                    } else {
                      // open: temporarily remove max-height to measure true height, then animate
                      panel.style.maxHeight = 'none';
                      requestAnimationFrame(function () {
                        var h = panel.scrollHeight || 0;
                        if (!h && panel.children && panel.children.length) {
                          var sum = 0;
                          for (var i = 0; i < panel.children.length; i++) sum += panel.children[i].offsetHeight || 0;
                          h = sum || 0;
                        }
                        panel.style.maxHeight = '0';
                        void panel.offsetHeight;
                        panel.style.maxHeight = h > 0 ? h + 'px' : '9999px';
                        panel.setAttribute('data-open', 'true');
                        if (icon) icon.style.transform = 'rotate(90deg)';
                        var onTrans = function () {
                          if (panel.getAttribute('data-open') === 'true')
                            panel.style.maxHeight = panel.scrollHeight + 'px';
                          panel.removeEventListener('transitionend', onTrans);
                        };
                        panel.addEventListener('transitionend', onTrans);
                      });
                    }
                  });
                });
              }
              if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindFixingToggles);
              else bindFixingToggles();
            })();
          </script>

          <div class="mt-6 space-y-4">
            <div>
              <label for="Cart-Note" class="block text-sm font-medium mb-1">Order note</label>
              <textarea id="Cart-Note" name="note" class="w-full border rounded p-2" rows="3">{{ cart.note }}</textarea>
            </div>

            <div class="flex items-center">
              <input
                id="AuthorityToLeave"
                type="checkbox"
                name="attributes[Authority to leave]"
                value="Yes"
                {% if cart.attributes['Authority to leave'] == 'Yes' %}
                  checked
                {% endif %}
                class="mr-2"
              >
              <label for="AuthorityToLeave" class="text-sm"
                >I give authority to leave the parcel if I'm not available</label
              >
            </div>

            {%- comment -%} Update handled in-place via AJAX or by changing quantities; remove explicit Update button per design {%- endcomment -%}
          </div>
        </form>
      </div>

      <div class="p-4">
        <div class="max-w-sm mr-0 ml-auto">
          <div class="mb-4">
            <div class="flex justify-between">
              <span id="cart-subtotal-label"
                >Subtotal ({{ cart.item_count }} item{% unless cart.item_count == 1 %}s{% endunless %})</span
              ><span id="cart-subtotal-server" class="font-semibold">{{ cart.items_subtotal_price | money }}</span>
            </div>
            <div class="flex text-sm text-gray-600">{{ 'cart.general.taxes_included_shipping_at_checkout' | t }}</div>
          </div>
          <a id="cart-checkout-btn" href="/checkout" class="block w-full text-center bg-black text-white py-3 rounded"
            >Checkout</a
          >
          {% if settings.cart_trust_badge %}
            <div class="my-4 flex justify-center w-4/5 m-auto">
              <img
                src="{{ settings.cart_trust_badge | img_url: '1080x' }}"
                alt="Trust badge"
                class=" object-contain"
                width="400"
                height="400"
              >
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</section>

<script>
  document.getElementById('esafetyClearCart').addEventListener('click', function (e) {
    e.preventDefault();
    fetch('/cart/clear.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then((data) => {
        // Successfully cleared the cart, now reload the page
        window.location.reload();
      })
      .catch((error) => {
        console.error('There was a problem with the fetch operation:', error);
      });
  });
</script>
