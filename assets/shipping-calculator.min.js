class ShippingCalculator extends HTMLElement{constructor(){super()}connectedCallback(){this.apiKey="d0b9db77d62442edb7301ddd4dbc8297",this.subscriptionKey="2753e655f9704eea8ad3e957f72642e2";const t=this.getAttribute("data-product");let i={};if(t)try{i=JSON.parse(t)}catch(t){i={}}this.product=i,this.isLoading=!1,this.shippingRates=[],this.errors=[],this.noShippingRates=!1,this.isFreeShipping=!1,this.findElements(),this.bind(),this.initState()}disconnectedCallback(){this._boundClick&&this.calculateBtn&&this.calculateBtn.removeEventListener("click",this._boundClick)}findElements(){this.form=this.querySelector('form[data-address="root"]')||this.querySelector("form"),this.fieldQuantity=this.querySelector("#QuantityShipping")||this.form&&this.form.querySelector('input[name="quantity"]'),this.fieldStreet=this.querySelector("#AddressAddress1")||this.form&&this.form.querySelector('input[name*="address1"]'),this.fieldCity=this.querySelector("#AddressCity")||this.form&&this.form.querySelector('input[name*="city"]'),this.fieldProvince=this.querySelector("#AddressProvince")||this.form&&this.form.querySelector('select[name*="province"]'),this.fieldCountry=this.querySelector("#AddressCountry")||this.form&&this.form.querySelector('select[name*="country"]'),this.fieldZip=this.querySelector("#AddressZip")||this.form&&this.form.querySelector('input[name*="zip"]'),this.calculateBtn=this.querySelector(".shipping-rate-button button, .m-spinner-button, button[data-shipping-calc]"),this.spinnerEl=this.querySelector(".m-spinner-icon"),this.resultsEl=this.querySelector(".shipping-rates-result")||this.querySelector("#shipping-results")}bind(){this.calculateBtn&&(this._boundClick=t=>{t.preventDefault(),this.handleCalculate()},this.calculateBtn.addEventListener("click",this._boundClick))}initState(){if(this.spinnerEl&&(this.spinnerEl.style.display="none"),this.calculateBtn&&(this.calculateBtn.disabled=!1,this.calculateBtn.classList.remove("opacity-60","cursor-not-allowed")),this.resultsEl){this.resultsEl.querySelectorAll("ul").forEach(t=>t.style.display="none");this.resultsEl.querySelectorAll("div").forEach(t=>t.style.display="none")}}readForm(){let t=null;if(this.fieldQuantity){const i=String(this.fieldQuantity.value||"").trim();t=""===i?null:parseInt(i,10)}else t=1;return{quantity:t,street:this.fieldStreet&&this.fieldStreet.value||null,city:this.fieldCity&&this.fieldCity.value||null,province:this.fieldProvince&&this.fieldProvince.value||null,country:this.fieldCountry&&this.fieldCountry.value||"AU",zip:this.fieldZip&&this.fieldZip.value||null}}setLoading(t){this.isLoading=t,this.spinnerEl&&(this.spinnerEl.style.display=t?"inline-block":"none"),this.calculateBtn&&(this.calculateBtn.disabled=!!t,t?this.calculateBtn.classList.add("opacity-60","cursor-not-allowed"):this.calculateBtn.classList.remove("opacity-60","cursor-not-allowed"))}async handleCalculate(){if(!this.resultsEl)return;this.resultsEl.innerHTML="";const t=this.readForm(),i=[];if((!t.quantity||Number.isNaN(t.quantity)||t.quantity<=0)&&i.push("Quantity"),t.zip&&""!==String(t.zip).trim()||i.push("Postcode"),i.length>0)return this.errors=i.map(t=>({details:`${t} is required`})),void this.renderErrors();this.setLoading(!0),this.shippingRates=[],this.noShippingRates=!1,this.errors=[],this.isFreeShipping=!1;const e={rate:{destination:{address1:t.street,address:null,address3:null,suburb:t.city,city:t.city,province:t.province,postal_code:t.zip,country:t.country},items:[{name:this.product.title,sku:this.product.sku||null,quantity:t.quantity,price:this.product.price,grams:this.product.grams||0}],currency:"AUD",carrierId:null}};try{const t=`https://api.starshipit.com/api/rates/shopify?apiKey=${encodeURIComponent(this.apiKey)}`,i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","StarShipIT-Api-Key":this.apiKey,"Ocp-Apim-Subscription-Key":this.subscriptionKey},body:JSON.stringify(e)});if(!i.ok){const t=await i.text();throw new Error("Network error: "+i.status+" "+t)}const s=await i.json();s&&Array.isArray(s.rates)&&s.rates.length>0?(this.shippingRates=s.rates,(this.shippingRates.some(t=>t&&t.service_code&&String(t.service_code).includes("Free"))||this.shippingRates.some(t=>t&&(0===Number(t.total_price)||0===Number(t.price))))&&(this.isFreeShipping=!0),this.renderResults()):(this.noShippingRates=!0,this.renderNoRates())}catch(t){this.errors=[{details:t.message}],this.renderErrors()}finally{this.setLoading(!1)}}renderResults(){if(!this.resultsEl)return;if(this.isFreeShipping)return void(this.resultsEl.innerHTML='<div class="free-shipping-msg" style="color:#16a34a;font-weight:600;padding:8px 0;">Eligible for Free Shipping</div>');const t=`<ul class="shipping-rate">${this.shippingRates.map(t=>`\n        <li>\n          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">\n            <path d="M12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22Z" stroke="#20782C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n            <path d="M7.75 11.9999L10.58 14.8299L16.25 9.16992" stroke="#20782C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n          <p>Your estimate: <strong>$${void 0!==t.total_price?parseFloat(t.total_price).toFixed(2):t.price||"â€”"}</strong></p>\n        </li>`).join("")}</ul>`;this.resultsEl.innerHTML=t}renderNoRates(){this.resultsEl&&(this.resultsEl.innerHTML='<div class="no-shipping-rates"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22Z" stroke="#5D5D5D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><div><p><strong>No shipping</strong></p><p>Please contact support.</p></div></div>')}renderErrors(){if(!this.resultsEl)return;const t=this.errors.map(t=>`<p role="alert" style="color:#dc2626;margin:0 0 8px;">${t&&t.details?t.details:String(t)}</p>`).join("");this.resultsEl.innerHTML=`<div class="shipping-errors">${t}</div>`}}customElements.get("shipping-calculator")||customElements.define("shipping-calculator",ShippingCalculator);