class CollectionFilters extends HTMLElement{constructor(){super()}get sectionId(){return this.dataset.sectionId}connectedCallback(){this.filterInputs=this.querySelectorAll("input"),this.handleClick=this.handleClick.bind(this),this.minRange=this.querySelector('input[type="range"][data-min-value]'),this.maxRange=this.querySelector('input[type="range"][data-max-value]'),this.filterInputs.forEach(e=>{e.addEventListener("change",this.handleClick)}),this._initPriceRange(),this._removePriceHandler=e=>{const t=e.target.closest("[data-remove-price]");if(!t)return;const i=t.getAttribute("data-section-id"),r=t.getAttribute("data-min-param"),n=t.getAttribute("data-max-param");if(!i||!r||!n)return;const a=Array.from(document.querySelectorAll("accordion-tab")).map((e,t)=>e.classList.contains("accordion-open")?t:-1).filter(e=>-1!==e),l=new URL(location.href);l.searchParams.delete(r),l.searchParams.delete(n),l.searchParams.set("section_id",i),this._showSpinner(),performSectionUpdate(l,a,"clearing price filter").catch(e=>console.error("Error clearing price filter:",e)).finally(()=>this._hideSpinner())},document.addEventListener("click",this._removePriceHandler),CollectionFilters._sortListenerAdded||(CollectionFilters._sortListenerAdded=!0,document.addEventListener("change",e=>{const t=e.target.closest("[data-collection-sort]");if(!t)return;const i=t.getAttribute("data-section-id"),r=t.value,n=Array.from(document.querySelectorAll("accordion-tab")).map((e,t)=>e.classList.contains("accordion-open")?t:-1).filter(e=>-1!==e),a=t.getAttribute("data-base-url");let l=new URL(location.href);if(a)try{const e=new URL(a,window.location.origin);l.pathname=e.pathname,e.searchParams.forEach((e,t)=>{l.searchParams.has(t)||l.searchParams.set(t,e)})}catch(e){l=new URL(location.href)}r?l.searchParams.set("sort_by",r):l.searchParams.delete("sort_by"),l.searchParams.set("section_id",i);const c=document.querySelector("collection-filters");c&&c._showSpinner(),performSectionUpdate(l,n,"changing sort").catch(e=>console.error("Error changing sort:",e)).finally(()=>{c&&c._hideSpinner()})}))}handleClick(e){const t=e.currentTarget;let i;this.filterTabs=Array.from(document.querySelectorAll("accordion-tab")),t.dataset.addUrl&&t.dataset.removeUrl?i=new URL(t.checked?t.dataset.addUrl:t.dataset.removeUrl,window.location.origin):(i=new URL(location.href),i.searchParams.delete(this.minRange.dataset.param),i.searchParams.delete(this.maxRange.dataset.param),i.searchParams.set(this.minRange.dataset.param,this.minRange.value),i.searchParams.set(this.maxRange.dataset.param,this.maxRange.value)),i.searchParams.set("section_id",this.sectionId),this._showSpinner();performSectionUpdate(i,this.filterTabs.map((e,t)=>e.classList.contains("accordion-open")?t:-1).filter(e=>-1!==e),"fetching collection filters").catch(e=>{console.error("Error fetching collection filters:",e)}).finally(()=>{this._hideSpinner()})}_showSpinner(){if(document.getElementById("collection-filter-spinner"))return;const e=document.createElement("div");e.id="collection-filter-spinner",e.setAttribute("aria-hidden","true"),e.className="fixed inset-0 z-50 flex items-center justify-center bg-white/60",e.innerHTML='\n      <div class="flex items-center gap-3 p-4">\n        <svg class="animate-spin h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>\n        </svg>\n      \n      </div>\n    ',document.body.appendChild(e)}_hideSpinner(){const e=document.getElementById("collection-filter-spinner");e&&e.remove()}_initPriceRange(){const e=this.querySelector(".price-range-wrapper");if(!e)return;if(this._priceMinEl=e.querySelector("input[data-min-value]"),this._priceMaxEl=e.querySelector("input[data-max-value]"),this._priceValMin=e.querySelector("[data-value-min]"),this._priceValMax=e.querySelector("[data-value-max]"),!this._priceMinEl||!this._priceMaxEl)return;const t=parseFloat(this._priceMinEl.min)||0,i=parseFloat(this._priceMinEl.max)||100;this._priceFill=e.querySelector(".range-fill");const r=(e,t,i)=>Math.min(Math.max(e,t),i),n=e=>{try{return Number(e).toFixed(2)}catch(t){return Number(e).toFixed(2)}},a=e=>{let a=r(parseFloat(this._priceMinEl.value),t,i),l=r(parseFloat(this._priceMaxEl.value),t,i);a>l&&(e===this._priceMinEl?(a=l,this._priceMinEl.value=a):(l=a,this._priceMaxEl.value=l));const c=(a-t)/(i-t)*100,s=(l-t)/(i-t)*100;this._priceFill&&(this._priceFill.style.left=c+"%",this._priceFill.style.width=Math.max(0,s-c)+"%"),this._priceValMin&&("INPUT"===this._priceValMin.tagName?this._priceValMin.value=n(a):this._priceValMin.textContent=n(a)),this._priceValMax&&("INPUT"===this._priceValMax.tagName?this._priceValMax.value=n(l):this._priceValMax.textContent=n(l))};this._priceMinHandler=()=>a(this._priceMinEl),this._priceMaxHandler=()=>a(this._priceMaxEl),this._priceMinEl.addEventListener("input",this._priceMinHandler),this._priceMaxEl.addEventListener("input",this._priceMaxHandler);if(this._priceValMin&&"INPUT"===this._priceValMin.tagName){this._priceValMinTimer=null;const e=()=>{let e=parseFloat(this._priceValMin.value);e=r(isNaN(e)?t:e,t,i),this._priceMinEl.value=e,a(this._priceMinEl);try{this._priceMinEl.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){const t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!1),this._priceMinEl.dispatchEvent(t)}};this._priceValMinHandler=()=>{let a=parseFloat(this._priceValMin.value);a=isNaN(a)?"":r(a,t,i),""!==a&&(this._priceValMin.value=n(a)),clearTimeout(this._priceValMinTimer),this._priceValMinTimer=setTimeout(e,600)},this._priceValMinBlur=()=>{clearTimeout(this._priceValMinTimer),e()},this._priceValMinKey=t=>{"Enter"===t.key&&(t.preventDefault(),clearTimeout(this._priceValMinTimer),e())},this._priceValMin.addEventListener("input",this._priceValMinHandler),this._priceValMin.addEventListener("blur",this._priceValMinBlur),this._priceValMin.addEventListener("keydown",this._priceValMinKey)}if(this._priceValMax&&"INPUT"===this._priceValMax.tagName){this._priceValMaxTimer=null;const e=()=>{let e=parseFloat(this._priceValMax.value);e=r(isNaN(e)?i:e,t,i),this._priceMaxEl.value=e,a(this._priceMaxEl);try{this._priceMaxEl.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){const t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!1),this._priceMaxEl.dispatchEvent(t)}};this._priceValMaxHandler=()=>{let a=parseFloat(this._priceValMax.value);a=isNaN(a)?"":r(a,t,i),""!==a&&(this._priceValMax.value=n(a)),clearTimeout(this._priceValMaxTimer),this._priceValMaxTimer=setTimeout(e,600)},this._priceValMaxBlur=()=>{clearTimeout(this._priceValMaxTimer),e()},this._priceValMaxKey=t=>{"Enter"===t.key&&(t.preventDefault(),clearTimeout(this._priceValMaxTimer),e())},this._priceValMax.addEventListener("input",this._priceValMaxHandler),this._priceValMax.addEventListener("blur",this._priceValMaxBlur),this._priceValMax.addEventListener("keydown",this._priceValMaxKey)}let l=null;const c=e.querySelector(".relative")||e,s=e=>{const n=c.getBoundingClientRect(),a=r(e-n.left,0,n.width)/n.width;return t+a*(i-t)},o=e=>{if(!l)return;const n=s(e.clientX);l.value=r(n,t,i),a(l)},d=()=>{if(window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",d),l)try{l.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){const t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!1),l.dispatchEvent(t)}l=null};e.addEventListener("pointerdown",e=>{if(e.target.closest("[data-value-min],[data-value-max]"))return;if(e.button&&0!==e.button)return;e.preventDefault();const n=s(e.clientX),h=parseFloat(this._priceMinEl.value),p=parseFloat(this._priceMaxEl.value),u=(h-t)/(i-t),m=(p-t)/(i-t),_=c.getBoundingClientRect(),M=r((e.clientX-_.left)/_.width,0,1),v=Math.abs(M-u),f=Math.abs(M-m);l=v<=f?this._priceMinEl:this._priceMaxEl,l.value=r(n,t,i),a(l),window.addEventListener("pointermove",o),window.addEventListener("pointerup",d)}),a()}_destroyPriceRange(){this._priceMinEl&&this._priceMinHandler&&this._priceMinEl.removeEventListener("input",this._priceMinHandler),this._priceMaxEl&&this._priceMaxHandler&&this._priceMaxEl.removeEventListener("input",this._priceMaxHandler),this._priceValMin&&this._priceValMinHandler&&this._priceValMin.removeEventListener("input",this._priceValMinHandler),this._priceValMax&&this._priceValMaxHandler&&this._priceValMax.removeEventListener("input",this._priceValMaxHandler),this._priceValMin&&this._priceValMinBlur&&this._priceValMin.removeEventListener("blur",this._priceValMinBlur),this._priceValMax&&this._priceValMaxBlur&&this._priceValMax.removeEventListener("blur",this._priceValMaxBlur),this._priceValMin&&this._priceValMinKey&&this._priceValMin.removeEventListener("keydown",this._priceValMinKey),this._priceValMax&&this._priceValMaxKey&&this._priceValMax.removeEventListener("keydown",this._priceValMaxKey),clearTimeout(this._priceValMinTimer),clearTimeout(this._priceValMaxTimer),this._priceMinEl=null,this._priceMaxEl=null,this._priceValMin=null,this._priceValMax=null,this._priceMinHandler=null,this._priceMaxHandler=null,this._priceFill=null}disconnectedCallback(){this._destroyPriceRange(),this.filterInputs.forEach(e=>{e.removeEventListener("change",this.handleClick)}),document.removeEventListener("click",this._removePriceHandler)}}function getSortLabel(e){switch(String(e)){case"best-selling":return"Best selling";case"title-ascending":return"Alphabetically, A–Z";case"title-descending":return"Alphabetically, Z–A";case"price-ascending":return"Price, low to high";case"price-descending":return"Price, high to low";case"created-descending":return"Date, new to old";case"created-ascending":return"Date, old to new";default:return"Featured"}}function initSortDisplays(){try{const e=new URL(location.href).searchParams.get("sort_by")||"manual";document.querySelectorAll("[data-collection-sort]").forEach(function(t){try{t.value=e}catch(e){}}),document.querySelectorAll("[data-sort-display]").forEach(function(t){t.textContent=getSortLabel(e)})}catch(e){}}function performSectionUpdate(e,t=[],i="section update"){const r="string"==typeof e?e:e.toString();try{closeDrawerIfOpen()}catch(e){}return fetch(r).then(e=>e.text()).then(e=>{const i=document.createElement("div");i.innerHTML=e;try{const e=i.querySelectorAll("accordion-tab");t.forEach(t=>{const i=e[t];i&&i.classList.add("accordion-open")})}catch(e){}const n=document.querySelector(".collection-inner-element");n&&i.querySelector(".collection-inner-element")&&(n.innerHTML=i.querySelector(".collection-inner-element").innerHTML);try{const e=new URL(r,window.location.origin);e.searchParams.delete("section_id"),window.history.pushState({},"",e.toString())}catch(e){}try{initSortDisplays()}catch(e){}}).catch(e=>{throw console.error("Error during "+i+":",e),e})}function closeDrawerIfOpen(){const e=document.getElementById("collection-filter-drawer");if(!e)return;const t=e.querySelector("#collection-filter-drawer-panel");t&&t.classList.add("-translate-x-full"),setTimeout(()=>{document.body.classList.remove("overflow-hidden"),e.remove()},260)}function initFilterDrawer(){document.addEventListener("click",function(e){const t=e.target.closest('[data-action="toggle-filter"]');if(!t)return;e.preventDefault();const i=t.closest('section[id^="collection-section-"]')||document.querySelector("section");if(!i)return;i.id&&(i.id.match(/(\d+)$/)||[null,null])[1];const r=document.createElement("div");r.id="collection-filter-drawer",r.className="fixed inset-0 z-50",r.innerHTML='\n      <div class="fixed inset-0 bg-black/40" id="collection-filter-backdrop"></div>\n      <div id="collection-filter-drawer-panel" class="fixed left-0 top-0 h-full w-full max-w-sm bg-white overflow-auto p-4 transform -translate-x-full transition-transform duration-300">\n        <div class="flex items-center justify-between mb-4">\n          <h3 class="text-lg font-semibold">Filters</h3>\n          <button aria-label="Close filters" data-action="close-filter" class="p-2">&times;</button>\n        </div>\n        <div class="collection-filter-drawer-inner">Loading…</div>\n      </div>\n    ',document.body.appendChild(r),document.body.classList.add("overflow-hidden");const n=r.querySelector("#collection-filter-drawer-panel");function a(){n.classList.add("-translate-x-full"),setTimeout(()=>{document.body.classList.remove("overflow-hidden"),r.remove()},260),document.removeEventListener("keydown",l)}requestAnimationFrame(()=>{n.classList.remove("-translate-x-full")}),r.addEventListener("click",function(e){const t=!!e.target.closest("#collection-filter-drawer-panel"),i=!!e.target.closest('[data-action="close-filter"]')||"collection-filter-backdrop"===e.target.id;t&&!i||a()});const l=e=>{"Escape"===e.key&&a()};document.addEventListener("keydown",l);const c=r.querySelector(".collection-filter-drawer-inner"),s=i.querySelector("aside")||document.querySelector("aside");c.innerHTML=s?s.innerHTML:""})}customElements.define("collection-filters",CollectionFilters),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){initSortDisplays(),initFilterDrawer()}):(initSortDisplays(),initFilterDrawer()),document.addEventListener("click",function(e){const t=e.target.closest("[data-clear-filters]");if(!t)return;e.preventDefault();try{closeDrawerIfOpen()}catch(e){}const i=t.closest('section[id^="collection-section-"]')||document.querySelector('section[id^="collection-section-"]');let r=null;if(i&&i.id){const e=i.id.match(/(\d+)$/);e&&(r=e[1])}const n=new URL(location.href),a=n.searchParams.get("q");n.search="",a&&n.searchParams.set("q",a),r&&n.searchParams.set("section_id",r),performSectionUpdate(n,[],"clearing filters").catch(e=>console.error("Clear filters failed",e))});