class ProductFixingAddons extends HTMLElement{connectedCallback(){try{this.setup()}catch(t){console.error("product-fixing init",t)}}setup(){if(this.form=document.querySelector("#product-act-button form"),this.form&&!this.form._productFixingHandlerAttached){if(this.form._productFixingHandlerAttached=!0,!window.__pf_fetch_patched){window.__pf_fetch_patched=!0;const t=window.fetch.bind(window);window.fetch=async function(e,n){const a=await t(e,n);try{const n="string"==typeof e?e:e&&e.url;if(n&&-1!==n.indexOf("/cart/add.js")&&window.__pf_pendingAddon){let e=null;try{e=await a.clone().json()}catch(t){e=null}const n=e&&e.key?e.key:null,i=window.__pf_pendingAddon,o=n?{is_addon:"true",parent_key:n}:{is_addon:"true"};try{await t("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i.addonId,quantity:i.qty,properties:o})})}catch(t){console.error("Failed to add addon after main add",t)}if("function"==typeof window.fetchCart)try{await window.fetchCart()}catch(t){}if("function"==typeof window.openCartDrawer);else{const t=document.getElementById("cart-btn");t&&t.click()}delete window.__pf_pendingAddon}}catch(t){}return a}}this.form.addEventListener("submit",async function(t){const e=document.querySelector("product-fixing-addons .addon-radio:checked");if(!e)return;const n=Number(e.dataset.variantId||e.value)||null;if(!n)return;t.preventDefault(),t.stopImmediatePropagation&&t.stopImmediatePropagation();let a=1;try{const t=new FormData(this);a=Number(t.get("quantity")||this.querySelector('input[name="quantity"]')?.value||1)||1}catch(t){a=1}const i=this.querySelector('button[type="submit"]'),o=i?i.textContent:null;i&&(i.innerHTML='<svg class="animate-spin inline-block w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>',i.disabled=!0,i.setAttribute("aria-busy","true"));try{const e=new FormData(this),i=Number(e.get("id")||this.querySelector('input[name="id"]')?.value);if(n){const e=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,quantity:a,properties:{fixing_id:String(n)}})});let o=null;try{o=await e.json()}catch(t){o=null}const r=o&&o.key?o.key:null,c=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n,quantity:a,properties:r?{is_addon:"true",parent_key:r}:{is_addon:"true"},sections:"esaftey-cart-drawer,cart-count"})});let d=null;try{d=await c.json()}catch(t){d=null}try{document.documentElement.dispatchEvent(new CustomEvent("cart:render",{detail:d,bubbles:!0}))}catch(t){}}else{const e=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,quantity:a,sections:"esaftey-cart-drawer,cart-count"})});let n=null;try{n=await e.json()}catch(t){n=null}try{document.documentElement.dispatchEvent(new CustomEvent("cart:render",{detail:n,bubbles:!0}))}catch(t){}}if("function"==typeof fetchCart)try{await fetchCart()}catch(t){}if("function"==typeof openCartDrawer)try{openCartDrawer()}catch(t){}else{const t=document.getElementById("cart-btn");t&&t.click()}}catch(e){console.error("Add to cart (fixings) failed",e);try{this.submit()}catch(t){}}finally{console.log("openCartDrawer called"),i&&setTimeout(()=>{i.textContent=o||"",i.disabled=!1,i.removeAttribute("aria-busy")},300)}},!0)}}}customElements.define("product-fixing-addons",ProductFixingAddons);