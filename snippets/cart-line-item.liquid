{%- assign has_addons = false -%}
{%- for addon_check in cart.items -%}
  {%- if addon_check.properties.parent_key == item.key -%}
    {%- assign has_addons = true -%}
  {%- endif -%}
{%- endfor -%}

{%- assign is_addon = false -%}
{%- if item.properties.is_addon == 'true' -%}
  {%- assign is_addon = true -%}
{%- endif -%}
{%- assign in_drawer = false -%}
{%- if drawer == true or drawer == 'true' -%}
  {%- assign in_drawer = true -%}
{%- endif -%}

<div
  class="py-4 grid gap-4 border-b border-grey md:grid-cols-4"
  data-has-addons="{{ has_addons }}"
>
  <!-- Product column -->
  <div class="flex items-start space-x-4">
    {% if item.image %}
      <a href="{{ item.url }}" class="inline-block">
        <img
          src="{{ item.image | img_url: '300x' }}"
          alt="{{ item.title }}"
          class="size-28 object-contain border border-grey p-2 rounded"
          width="80"
          height="80"
        >
      </a>
    {% else %}
      <div class="size-28 bg-gray-100 rounded"></div>
    {% endif %}

    <div class="flex-1">
      <div class="text-sm font-semibold">
        <a href="{{ item.url }}" class="hover:underline">{{ item.title }}</a>
      </div>

      {%- assign show_options = false -%}
      {%- if item.options_with_values -%}
        {%- for opt in item.options_with_values -%}
          {%- if opt.value and opt.value != 'Default Title' -%}
            {%- assign show_options = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if show_options -%}
        <div class="text-sm text-gray-600">
          {%- for opt in item.options_with_values -%}
            <span class="block">{{ opt.name }}: {{ opt.value }}</span>
          {%- endfor -%}
        </div>
      {%- elsif item.variant.title != 'Default Title' -%}
        <div class="text-sm text-gray-600">{{ item.variant.title }}</div>
      {%- endif -%}
      <div class="text-sm text-gray-600">{% render 'cart-line-property', item: item %}</div>
      {% if has_addons %}
        <div class="mt-2">
          <button
            type="button"
            class="view-fixings-btn text-xs text-gray-600 flex items-center gap-1 underline"
            data-parent-key="{{ item.key }}"
          >
            <span>View Fixings</span>
            {% render 'icon-svg-chevron-right', class: 'size-4 view-fixings-icon transition-transform duration-200' %}
          </button>
          <div
            class="fixings-panel overflow-hidden mt-2"
            data-parent-key="{{ item.key }}"
            style="max-height:0; transition:max-height 300ms ease;"
          >
            {% render 'cart-fixing-list', parent_key: item.key %}
          </div>
          <script>
            (function () {
              var key = '{{ item.key }}';
              try {
                var btn = document.querySelector('.view-fixings-btn[data-parent-key="' + key + '"]');
                var panel = document.querySelector('.fixings-panel[data-parent-key="' + key + '"]');
                if (!btn || !panel) return;
                if (btn._fixingsBound) return;
                btn._fixingsBound = true;
                btn.addEventListener('click', function () {
                  var icon = btn.querySelector('.view-fixings-icon');
                  var isOpen = panel.getAttribute('data-open') === 'true';
                  if (isOpen) {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                    void panel.offsetHeight;
                    panel.style.maxHeight = '0';
                    panel.setAttribute('data-open', 'false');
                    if (icon) icon.style.transform = '';
                  } else {
                    panel.style.maxHeight = 'none';
                    requestAnimationFrame(function () {
                      var h = panel.scrollHeight || 0;
                      panel.style.maxHeight = '0';
                      void panel.offsetHeight;
                      panel.style.maxHeight = h > 0 ? h + 'px' : '9999px';
                      panel.setAttribute('data-open', 'true');
                      if (icon) icon.style.transform = 'rotate(90deg)';
                      var onTrans = function () {
                        if (panel.getAttribute('data-open') === 'true')
                          panel.style.maxHeight = panel.scrollHeight + 'px';
                        panel.removeEventListener('transitionend', onTrans);
                      };
                      panel.addEventListener('transitionend', onTrans);
                    });
                  }
                });
              } catch (e) {
                console.error('Fixings toggle error', e);
              }
            })();
          </script>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Price -->
  <div class="w-full ml-auto flex flex-col gap-2 items-end md:items-center">
    <div><span class="sm:hidden">Price: &nbsp;</span>{{ item.price | money }}</div>
    {% if item.discounts[0].title %}
      <div class="text-xs text-bg-light-red flex">
        <div class="flex gap-1 items-center">
          {% render 'icon-svg-tag', class: 'size-3' -%}
          <span class="uppercase">{{- item.discounts[0].title }}</span>
        </div>
        <div>- {{ item.discounts[0].amount | money }}</div>
      </div>
    {% endif %}
  </div>

  <!-- Quantity -->
  <div class="w-full ml-auto flex justify-end md:justify-center">
    {% if in_drawer and is_addon %}
      <div class="text-sm text-gray-700">Qty: {{ item.quantity }}</div>
    {% else %}
      {% render 'cart-qty-control', key: item.key, qty: item.quantity, is_addon: has_addons %}
    {% endif %}
  </div>

  <!-- Total -->
  <div class="w-full ml-auto flex justify-end md:justify-center font-semibold">
    <span class="sm:hidden">Total: &nbsp;</span>{{ item.final_line_price | money }}
  </div>
</div>
