<script>
  (function(){
    function applyHoverImages(){
      if(window.matchMedia && window.matchMedia('(hover: hover) and (pointer: fine)').matches){
        document.querySelectorAll('img[data-hover-src]').forEach(function(img){
          if(!img.getAttribute('src')) img.setAttribute('src', img.getAttribute('data-hover-src'));
        });
      }
    }

    function handleSkeletonForCard(){
      var script = document.currentScript;
      if(!script) return;
      var article = script.closest('article.product-card');
      if(!article) return;
      var skeleton = article.querySelector('.image-skeleton');
      if(!skeleton) return;

      // Prefer the primary image in the card (first img)
      var primary = article.querySelector('img');
      var cleared = false;
      function hideSkeleton(){
        if(cleared) return;
        cleared = true;
        skeleton.style.display = 'none';
      }

      if(!primary){ hideSkeleton(); return; }
      if(primary.complete && primary.naturalWidth){ hideSkeleton(); return; }

      // hide when primary image loads or errors
      primary.addEventListener('load', hideSkeleton);
      primary.addEventListener('error', hideSkeleton);

      // Fallback: hide skeleton after 2s to avoid stuck placeholders for lazy/offscreen images
      setTimeout(hideSkeleton, 2000);
    }

    if(!window.__hoverImagesApplied){
      window.__hoverImagesApplied = true;
      applyHoverImages();
      document.addEventListener('DOMContentLoaded', applyHoverImages);
    } else {
      applyHoverImages();
    }

    // Run skeleton handler for this card
    try { handleSkeletonForCard(); } catch(e) { /* fail silently */ }
  })();
</script>
