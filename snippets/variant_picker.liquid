<script src="{{ 'variant-picker.js' | asset_url }}" defer="defer"></script>
{%  unless product.has_only_default_variant %}
   
        <variant-picker data-section-id="{{ section.id }}">
                        {% for option in product.options_with_values %}
                                <fieldset class="variant-picker__option mb-4">
                                        <legend class="variant-picker__label font-semibold mb-2">{{ option.name }}</legend>
                                        <div class="variant-picker__values flex flex-wrap gap-2">
                                                {% assign option_name_down = option.name | downcase %}
                                                {% for value in option.values %}
                                                    {% assign input_id = option.name | handleize | append: '-' | append: value.name | handleize %}
                                                        <input
                                                                type="radio"
                                                                id="{{ input_id }}" {% if option.selected_value == value %}checked{% endif %} name="{{ option.name }}"
                                                                value="{{ value.variant.id }}" class="hidden"
                                                        />
                                                        {% if option_name_down contains 'color' or option_name_down contains 'colour' %}
                                                            {% render 'color-swatch', for_id: input_id, color_name: value.name, value_name: value.name %}
                                                        {% else %}
                                                                <label
                                                                        for="{{ input_id }}"
                                                                        class="variant-picker__value cursor-pointer px-3 py-1 border rounded hover:bg-gray-100"
                                                                >
                                                                        {{ value.name }}
                                                                </label>
                                                        {% endif %}
                                                {% endfor %}
                                        </div>
                                </fieldset>
                        {% endfor %}
        </variant-picker>

        <script>
            (function () {
                function applyColorMap(map) {
                    document.querySelectorAll('.color-swatch-circle[data-color-name]').forEach(function (el) {
                        var name = el.getAttribute('data-color-name') || '';
                        var hex = map[name.toLowerCase()];
                        if (hex) {
                            el.style.backgroundColor = hex;
                            if (hex.toLowerCase() === '#ffffff' || hex.toLowerCase() === 'white') {
                                el.style.border = '1px solid #ddd';
                            }
                        } else {
                            // try if the name itself is a hex
                            if (/^#([0-9A-F]{3}){1,2}$/i.test(name.trim())) {
                                el.style.backgroundColor = name.trim();
                            } else {
                                // fallback: show text inside (accessible)
                                el.style.backgroundColor = 'transparent';
                                el.style.display = 'inline-flex';
                                el.style.alignItems = 'center';
                                el.style.justifyContent = 'center';
                                el.textContent = name.charAt(0);
                                el.style.fontSize = '10px';
                            }
                        }
                    });
                }

                function loadColorMapAndApply() {
                    var url = '{{ "color-map.json" | asset_url }}';
                    fetch(url).then(function (r) {
                        if (!r.ok) return {};
                        return r.json();
                    }).then(function (json) {
                        var normalized = {};
                        try {
                            Object.keys(json || {}).forEach(function (k) { normalized[k.toLowerCase()] = json[k]; });
                        } catch (e) { normalized = json || {}; }
                        applyColorMap(normalized || {});
                    }).catch(function () {
                        // ignore
                    });
                }

                document.addEventListener('DOMContentLoaded', loadColorMapAndApply);
                document.addEventListener('product:content:replaced', loadColorMapAndApply);
            })();
        </script>
{% endunless %}