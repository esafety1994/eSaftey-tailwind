<esafety-drawer>
  <div id="cart-overlay" class="fixed inset-0 bg-black/50 hidden z-50"></div>
  <aside
    id="cart-drawer"
    class="fixed right-0 top-0 h-full w-full max-w-md bg-white z-60 transform translate-x-full transition-transform shadow-lg flex flex-col duration-500 ease-in-out"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="cart-drawer-title"
  >
    <div
      class="flex items-center justify-between p-4"
      style="background: linear-gradient(215deg, rgba(254, 220, 19, 1) 0%, rgba(250, 200, 2, 1) 100%);"
    >
      <h3 id="cart-drawer-title" class="text-2xl font-semibold flex gap-3 items-center">
        {% render 'icon-svg-cart', class: 'size-6 text-gray-600' %}
        Shopping Cart
      </h3>
      <button
        data-drawer-close
        aria-label="Close cart"
        class="text-gray-900 cursor-pointer border p-1 rounded-full"
      >
        {% render 'icon-svg-close', class: size-3 %}
      </button>
    </div>

    <div id="cart-drawer-content" class="p-4 overflow-y-auto flex-1">
      {% render 'shipping-goals', cart: cart %}
      <div class="gradient-bg">
        <div class="content">
          <div>
            {% render 'icon-svg-marker' %}
            <span>Free Shipping for orders over $499</span>
          </div>
          <div>
            {% render 'icon-svg-package' %}
            <span>Click & Collect From our Wetherill Park Warehouse</span>
          </div>
        </div>
      </div>
      {% assign upsell = settings.cart_drawer_upsell_product %}
      {% assign upsell_in_cart = false %}
      {% for item_check in cart.items %}
        {% if upsell and item_check.product and item_check.product.id == upsell.id %}
          {% assign upsell_in_cart = true %}
        {% endif %}
      {% endfor %}

      {% if cart.item_count == 0 %}
        <div id="cart-items" class="space-y-4 overflow-auto"></div>
        <div id="cart-empty" class="text-center text-gray-600">Your cart is empty.</div>
      {% else %}
        <div id="cart-items" class="space-y-4 overflow-auto">
          {%- assign parent_index = 0 -%}
          {% for item in cart.items %}
            {% unless item.properties.is_addon == 'true' %}
              {%- assign parent_index = parent_index | plus: 1 -%}

              {% render 'cart-line-item-drawer', item: item, index: forloop.index %}
              {% if parent_index == 1 %}
                {% if upsell and upsell_in_cart != true %}
                  {% render 'cart-upsell-product' %}
                {% endif %}
              {% endif %}
            {% endunless %}
          {% endfor %}
        </div>
        <div id="cart-empty" class="hidden text-center text-gray-600">Your cart is empty.</div>
      {% endif %}
      <span id="cart-total" class="hidden">{{ cart.items_subtotal_price | money }}</span>
      <script>
        (function () {
          // Expose binding function so external code (AJAX updates) can re-run it
          window.bindDrawerFixingToggles = function bindDrawerFixingToggles() {
            document.querySelectorAll('#cart-drawer .view-fixings-btn').forEach(function (btn) {
              if (btn._fixingsBound) return;
              btn._fixingsBound = true;
              btn.addEventListener('click', function () {
                var key = btn.getAttribute('data-parent-key');
                var panel = document.querySelector('#cart-drawer .fixings-panel[data-parent-key="' + key + '"]');
                var icon = btn.querySelector('.view-fixings-icon');
                if (!panel) return;
                var isOpen = panel.getAttribute('data-open') === 'true';
                if (isOpen) {
                  panel.style.maxHeight = '0';
                  panel.setAttribute('data-open', 'false');
                  if (icon) icon.style.transform = '';
                } else {
                  panel.style.maxHeight = panel.scrollHeight + 'px';
                  panel.setAttribute('data-open', 'true');
                  if (icon) icon.style.transform = 'rotate(90deg)';
                  var onTrans = function () {
                    if (panel.getAttribute('data-open') === 'true') panel.style.maxHeight = panel.scrollHeight + 'px';
                    panel.removeEventListener('transitionend', onTrans);
                  };
                  panel.addEventListener('transitionend', onTrans);
                }
              });
            });
          };

          // Run initially
          if (document.readyState === 'loading')
            document.addEventListener('DOMContentLoaded', function () {
              window.bindDrawerFixingToggles();
            });
          else window.bindDrawerFixingToggles();

          // Observe drawer content for changes and re-bind when items are re-rendered
          (function () {
            var content = document.getElementById('cart-drawer-content');
            if (!content || !window.MutationObserver) return;
            var mo = new MutationObserver(function (mutations) {
              // re-bind after small delay to allow DOM insertion
              setTimeout(function () {
                if (typeof window.bindDrawerFixingToggles === 'function') window.bindDrawerFixingToggles();
              }, 20);
            });
            mo.observe(content, { childList: true, subtree: true });
          })();
        })();
      </script>
    </div>

    <div class="p-4">
      <form action="{{ routes.cart_url }}" method="post" class="mb-3">
        <label for="drawer-note" class="block text-sm font-medium mb-1">Order note</label>
        <textarea id="drawer-note" name="note" class="w-full border rounded p-2 mb-3" rows="2"></textarea>
        <div class="flex items-center mb-3">
          <input id="drawer-authority" type="checkbox" name="attributes[Authority to leave]" value="Yes" class="mr-2">
          <label for="drawer-authority" class="text-sm">Authority to leave</label>
        </div>
        <!-- Save button removed: attributes are saved on checkout click -->
      </form>

      <div class="flex items-center justify-between mb-3">
        <span id="cart-subtotal-label" class="font-medium">Subtotal (<span data-item-count-drawer>{{ cart.item_count }}</span> items)</span>
        <span id="cart-subtotal" data-cart-total-drawer class="font-semibold">{{ cart.total_price | money }}</span>
      </div>
      <div class="flex text-sm text-gray-600">{{ 'cart.general.taxes_included_shipping_at_checkout' | t }}</div>
      <div class="py-4 flex gap-3">
        <a href="/cart" class="w-3xs btn outline-button-rounded flex items-center
">View cart</a>
        <a
          id="cart-drawer-checkout-btn"
          href="/checkout"
          class="btn primary-checkout-button !text-sm"
          >{%render 'icon-svg-lock-keyhole' %}Secure Checkout</a
        >
          
      </div>
    </div>
  </aside>
</esafety-drawer>
