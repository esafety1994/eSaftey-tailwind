<esafety-drawer>
  <div id="cart-overlay" class="fixed inset-0 bg-black/50 hidden z-50"></div>
  <aside
    id="cart-drawer"
    class="fixed right-0 top-0 h-full w-full max-w-md bg-white z-60 transform translate-x-full transition-transform shadow-lg flex flex-col duration-500 ease-in-out"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="cart-drawer-title"
  >
    <div
      class="flex items-center justify-between p-4"
      style="background: linear-gradient(215deg, rgba(254, 220, 19, 1) 0%, rgba(250, 200, 2, 1) 100%);"
    >
      <h3 id="cart-drawer-title" class="text-2xl font-semibold flex gap-3 items-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="size-6 text-gray-600"
        >
          <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
        </svg>
        Shopping Cart
      </h3>
      <button
        data-drawer-close
        aria-label="Close cart"
        class="text-gray-900 cursor-pointer border p-1 rounded-full"
      >
        <svg
          class="size-3"
          fill="currentColor"
          stroke="currentColor"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 320 512"
        >
          <path d="M193.94 256L296.5 153.44l21.15-21.15c3.12-3.12 3.12-8.19 0-11.31l-22.63-22.63c-3.12-3.12-8.19-3.12-11.31 0L160 222.06 36.29 98.34c-3.12-3.12-8.19-3.12-11.31 0L2.34 120.97c-3.12 3.12-3.12 8.19 0 11.31L126.06 256 2.34 379.71c-3.12 3.12-3.12 8.19 0 11.31l22.63 22.63c3.12 3.12 8.19 3.12 11.31 0L160 289.94 262.56 392.5l21.15 21.15c3.12 3.12 8.19 3.12 11.31 0l22.63-22.63c3.12-3.12 3.12-8.19 0-11.31L193.94 256z"></path>
        </svg>
      </button>
    </div>
    <div class="gradient-bg">
      <div class="content">
        <div>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          <span>Free Shipping for orders over $499</span>
        </div>
        <div>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
            <path d="m3.3 7 8.7 5 8.7-5"/>
            <path d="M12 22V12"/>
          </svg>
          <span>Click & Collect From our Wetherill Park Warehouse</span>
        </div>
      </div>
    </div>
    <div id="cart-drawer-content" class="p-4 overflow-y-auto flex-1">
      {% assign upsell = settings.cart_drawer_upsell_product %}
      {% assign upsell_in_cart = false %}
      {% for item_check in cart.items %}
        {% if upsell and item_check.product and item_check.product.id == upsell.id %}
          {% assign upsell_in_cart = true %}
        {% endif %}
      {% endfor %}

      {% if cart.item_count == 0 %}
        <div id="cart-items" class="space-y-4 overflow-auto"></div>
        <div id="cart-empty" class="text-center text-gray-600">Your cart is empty.</div>
      {% else %}
        <div id="cart-items" class="space-y-4 overflow-auto">
          {%- assign parent_index = 0 -%}
          {% for item in cart.items %}
            {% unless item.properties.is_addon == 'true' %}
              {%- assign parent_index = parent_index | plus: 1 -%}

              {% render 'cart-line-item-drawer', item: item, index: forloop.index %}
              {% if parent_index == 1 %}
                {% if upsell and upsell_in_cart != true %}
                  {% render 'cart-upsell-product' %}
                {% endif %}
              {% endif %}
            {% endunless %}
          {% endfor %}
        </div>
        <div id="cart-empty" class="hidden text-center text-gray-600">Your cart is empty.</div>
      {% endif %}
<span id="cart-total" class="hidden">{{ cart.items_subtotal_price | money }}</span>
      <script>
        (function () {
          // Expose binding function so external code (AJAX updates) can re-run it
          window.bindDrawerFixingToggles = function bindDrawerFixingToggles() {
            document.querySelectorAll('#cart-drawer .view-fixings-btn').forEach(function (btn) {
              if (btn._fixingsBound) return;
              btn._fixingsBound = true;
              btn.addEventListener('click', function () {
                var key = btn.getAttribute('data-parent-key');
                var panel = document.querySelector('#cart-drawer .fixings-panel[data-parent-key="' + key + '"]');
                var icon = btn.querySelector('.view-fixings-icon');
                if (!panel) return;
                var isOpen = panel.getAttribute('data-open') === 'true';
                if (isOpen) {
                  panel.style.maxHeight = '0';
                  panel.setAttribute('data-open', 'false');
                  if (icon) icon.style.transform = '';
                } else {
                  panel.style.maxHeight = panel.scrollHeight + 'px';
                  panel.setAttribute('data-open', 'true');
                  if (icon) icon.style.transform = 'rotate(90deg)';
                  var onTrans = function () {
                    if (panel.getAttribute('data-open') === 'true') panel.style.maxHeight = panel.scrollHeight + 'px';
                    panel.removeEventListener('transitionend', onTrans);
                  };
                  panel.addEventListener('transitionend', onTrans);
                }
              });
            });
          };

          // Run initially
          if (document.readyState === 'loading')
            document.addEventListener('DOMContentLoaded', function () {
              window.bindDrawerFixingToggles();
            });
          else window.bindDrawerFixingToggles();

          // Observe drawer content for changes and re-bind when items are re-rendered
          (function () {
            var content = document.getElementById('cart-drawer-content');
            if (!content || !window.MutationObserver) return;
            var mo = new MutationObserver(function (mutations) {
              // re-bind after small delay to allow DOM insertion
              setTimeout(function () {
                if (typeof window.bindDrawerFixingToggles === 'function') window.bindDrawerFixingToggles();
              }, 20);
            });
            mo.observe(content, { childList: true, subtree: true });
          })();
        })();
      </script>
    </div>

    <div class="p-4">
      <form action="{{ routes.cart_url }}" method="post" class="mb-3">
        <label for="drawer-note" class="block text-sm font-medium mb-1">Order note</label>
        <textarea id="drawer-note" name="note" class="w-full border rounded p-2 mb-3" rows="2"></textarea>
        <div class="flex items-center mb-3">
          <input id="drawer-authority" type="checkbox" name="attributes[Authority to leave]" value="Yes" class="mr-2">
          <label for="drawer-authority" class="text-sm">Authority to leave</label>
        </div>
        <!-- Save button removed: attributes are saved on checkout click -->
      </form>

      <div class="flex items-center justify-between mb-3">
        <span id="cart-subtotal-label" class="font-medium">Subtotal (<span data-item-count-drawer>0</span> items)</span>
        <span id="cart-subtotal" data-cart-total-drawer class="font-semibold">$0.00</span>
      </div>
      <div class="flex text-sm text-gray-600">{{ 'cart.general.taxes_included_shipping_at_checkout' | t }}</div>
      <div class="py-4 flex gap-3">
        <a href="/cart" class="w-full text-center border py-2 rounded">View cart</a>
        <a
          id="cart-drawer-checkout-btn"
          href="/checkout"
          class="block w-full text-center bg-black text-primary-light py-3 rounded uppercase"
          >Checkout</a
        >
      </div>
    </div>
  </aside>
</esafety-drawer>
