{% comment %} Vertical accordion megamenu using a linklist passed as `menu_handle` {% endcomment %}
{% assign menu = linklists[menu_handle] %}
{% if menu and menu.links.size > 0 %}
  <nav class="mega-menu w-full">
    <ul class="space-y-2">
      {% for item in menu.links %}
        <li class="border-b border-transparent">
          {% if item.links and item.links.size > 0 %}
            {% assign has_children = true %}
          {% else %}
            {% assign has_children = false %}
          {% endif %}

          {% assign outer_index = forloop.index %}
          <div class="flex w-full items-center justify-between py-2">
            <a href="{{ item.url }}" class="text-sm text-white text-left flex-1">{{ item.title }}</a>
            {% if has_children %}
              <button class="mega-toggle ml-3 p-1" aria-expanded="false" data-target="mega-{{ outer_index }}" aria-label="Toggle {{ item.title }} submenu">
                <svg class="w-4 h-4 transform transition-transform" viewBox="0 0 20 20" fill="none" stroke="currentColor"><path d="M6 8l4 4 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            {% endif %}
          </div>

          {% if has_children %}
            <div id="mega-{{ outer_index }}" class="mega-panel">
              <ul class="pl-4 mt-2 space-y-1">
                {% for child in item.links %}
                  {% assign child_index = forloop.index %}
                  <li>
                    {% if child.links and child.links.size > 0 %}
                      {% assign has_grand = true %}
                    {% else %}
                      {% assign has_grand = false %}
                    {% endif %}

                    {% if has_grand %}
                      <div class="flex w-full items-center justify-between">
                        <a href="{{ child.url }}" class="block text-sm text-gray-200 pl-1 flex-1">{{ child.title }}</a>
                        <button class="mega-toggle ml-2 p-1" aria-expanded="false" data-target="mega-{{ outer_index }}-{{ child_index }}" aria-label="Toggle {{ child.title }} submenu">
                          <svg class="w-3 h-3 transform transition-transform" viewBox="0 0 20 20" fill="none" stroke="currentColor"><path d="M6 8l4 4 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                      </div>

                      <div id="mega-{{ outer_index }}-{{ child_index }}" class="mega-panel">
                        <ul class="pl-6 mt-2 space-y-1">
                          {% for grand in child.links %}
                            <li><a href="{{ grand.url }}" class="block text-sm text-gray-300 hover:text-white pl-1">{{ grand.title }}</a></li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% else %}
                      <a href="{{ child.url }}" class="block text-sm text-gray-200 hover:text-white pl-1">{{ child.title }}</a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </nav>
{% else %}
  <div class="text-sm text-gray-400">No menu assigned.</div>
{% endif %}
